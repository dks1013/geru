const moduleName = "libzwfeyyadt.so";
Stalker.queueDrainInterval = 10;

function startStalking(m) {
    const start = m.base;
    const end = m.base.add(m.size);

    function followThread(tid) {
        Stalker.follow(tid, {
            events: { exec: true },
            onReceive(events) {
                const parsed = Stalker.parse(events);
                parsed.forEach(e => {
                    if (e.address.compare(start) >= 0 &&
                        e.address.compare(end) < 0) {

                        console.log(
                            "[EXEC]",
                            e.address,
                            "offset",
                            e.address.sub(start)
                        );
                    }
                });
            }
        });
    }

    // 기존 스레드
    Process.enumerateThreads().forEach(t => {
        followThread(t.id);
    });

    // 새 스레드 생성 감시
    Interceptor.attach(
        Module.findExportByName(null, "pthread_create"),
        {
            onEnter(args) {
                this.newThread = args[0];
            },
            onLeave() {
                setTimeout(() => {
                    Process.enumerateThreads().forEach(t => {
                        followThread(t.id);
                    });
                }, 50);
            }
        }
    );
}

function waitForModule() {
    const m = Process.findModuleByName(moduleName);
    if (!m) {
        setTimeout(waitForModule, 100);
        return;
    }

    console.log("[+] module loaded:", m.base, m.size);
    startStalking(m);
}

waitForModule();